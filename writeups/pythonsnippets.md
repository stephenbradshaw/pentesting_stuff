# Python snippets

Some snippets of Python code that I use too infrequently to remember, but frequently enough to be annoyed every time I have to track down an example again.

## iPython3 execfile helper

Python3 removes execfile, so its nice to have a helper.

Simple:

`coder = lambda  x : compile(open(x).read(), x, 'exec')`

Use it like so:

`exec(coder(filename))`


More complex including setting the global `__file__` variable to the executed filename (which can sometimes be useful):

`coder = lambda  x : [compile(open(x).read(), x, 'exec'), globals().update({'__file__' : x})]`

Use:

`exec(*coder(filename))`


## Generate sortable timestamp

So the necessary import

`import datetime`

Timestamp with only the date

    def timestamp():
        return datetime.datetime.now().strftime('%Y%m%d')
        
Timestamp with date and time

    def timestamp():
        return datetime.datetime.now().strftime('%Y%m%d%H%M%S')
        
        
## An example HTML parser

An example of a HTMLPaser, you will need to edit this to make it useful, but remembering the template is always annoying.

    from html.parser import HTMLParser
    class HParser(HTMLParser):
        '''Example HTML parser'''
    
        def __init__(self):
            HTMLParser.__init__(self)
            self.outData = ''
            self.divData = ''
            self.inHtag = False
            self.inDtag = False
    
    
        def handle_starttag(self, tag, attrs):
            if tag == 'h1':
                inHtag = True
            elif tag == 'div':
                if (self.get_starttag_text().find('content') > -1):
                    self.inDtag = True
        
        def handle_endtag(self, tag):
            if tag == "h1":
                self.inHtag = False
            elif tag == "div":
                self.inDtag = False
    
    
        def handle_data(self, data):
            if self.inHtag:
                self.outData = self.outData + data
            elif self.inDtag:
                self.divData = self.divData + data
                
    
        def close(self):
            return [ self.outData, self.divData ]


## wsgi example to load a Flask app

Most of the times my Python helper servers are single use code and run temporarily listening on their own socket, but sometimes you want to offer multiple functions and take advantage of existing infrastructure, such as an existing https server with legitimate certificate. In this case, the following with the wsgi module will allow a web server like Apache to server the Python code.

    # if the app isn't already installed as a module or in the Python path, import sys and add the folder it sits in to Python path
    import sys
    sys.path.insert(0, '/usr/local/www/wsgi-scripts/')
    
    # where flask_app is the name of the script file/module
    from flask_app import app as application
    

A good reference for the Apache configuration is [here](https://modwsgi.readthedocs.io/en/develop/user-guides/quick-configuration-guide.html), which can be followed once the wsgi module is installed and enabled using a2enmod.  The WSGIScriptAlias and Allow/Require instructions (depending on version) are minimums, for SSL you may also want to add `SSLOptions +StdEnvVars`.

An example Flask app that could be loaded is [here](https://github.com/stephenbradshaw/pentesting_stuff/blob/master/helper_servers/flask_upload.py).
