# Creating a self signed certificate

## Create the Root CA key and Cert:

Run the following one-liner:

    openssl req -x509 -newkey rsa:4096 -sha256 -keyout rootca.key -out rootca.pem -days 1826 -nodes -subj "/C=AU/ST=A.C.T./L=Canberra/O=Secops/OU=Org/CN=RootCA"

The output:
* rootca.pem is your Root CA certificate
* rootca.key is the private key

## Create the device key, csr, and then sign it with the RootCA cert:

This will create a certificate with common name and alternative names set to the correct values.

Run the following commands, set DEVICENAME to the devices name and IP to the IP address:

    export DEVICENAME='hostname'
    export IP='192.168.0.1'
    openssl genrsa -out device.key 4096
    openssl req -new -sha256 -key device.key -out device.csr -subj "/C=AU/ST=A.C.T./L=Canberra/O=Secops/OU=Org/CN=$DEVICENAME" -reqexts SAN -config <(cat /etc/ssl/openssl.cnf && printf "\n[SAN]\nsubjectAltName=DNS:$DEVICENAME,DNS:$IP")
    openssl x509 -req -in device.csr -CA rootca.pem -CAkey rootca.key -CAcreateserial -out device.pem -days 1826 -sha256 -extensions SAN -extfile <(cat /etc/ssl/openssl.cnf && printf "\n[SAN]\nsubjectAltName=DNS:$DEVICENAME,DNS:$IP") 

The output:
* device.key is the device private key
* device.pem is the device certificate signed by the Root CA (use DEVICENAME variable to set the Common Name for the cert appropriately)
* device.csr is the signing request

## Non Root CA signed certificate

If you dont need to have your self signed cert signed by a Root CA to do the trust thing, you can generate a key and cert in one step as below. This will create a certificate with common name and alternative names set to the correct values.

    export DEVICENAME='hostname'
    export IP='192.168.0.1'
    openssl req -x509 -newkey rsa:4096 -keyout device1.key -out device1.pem -sha256 -days 1826 -nodes -subj "/C=AU/ST=A.C.T./L=Canberra/O=Secops/OU=Org/CN=$DEVICENAME" -extensions SAN -config <(cat /etc/ssl/openssl.cnf && printf "\n[SAN]\nsubjectAltName=DNS:$DEVICENAME,DNS:$IP")

The output:
* device.key is the device private key
* device.pem is the device self signed certificate (use DEVICENAME variable to set the Common Name for the cert appropriately)


## Trust a root CA signed certificate

On Ubuntu to add the signing Root CA to the local stores so it is trusted (The filename must end in .crt to be recognised, but the rest of the name doesn't matter too much):

    sudo cp rootca.pem /usr/share/ca-certificates/rootca.crt 
    sudo cp rootca.pem /usr/local/share/ca-certificates/rootca.crt


Then run the following commands to import the certificates into the various places that various components of Ubuntu look. 

    sudo dpkg-reconfigure ca-certificates
    sudo update-ca-certificates


If a Python application needs to trust the certificate, it may use the system store, or if the certifi module is installed it will use its own certificates file. You can find where it is using:

    >>> import certifi
    >>> certifi.where()


For Python requests, you can specify an alternate CA Bundle via an environment variable:

    export REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt


You can also append to the end of the certifi store using something like the following:

    (cat /usr/local/lib/python3.5/dist-packages/certifi/cacert.pem && printf "\n" && cat rootca.pem )| sudo tee /usr/local/lib/python3.5/dist-packages/certifi/cacert.pem > /dev/null
